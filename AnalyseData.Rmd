---
Title: "color-model-hlcam"
author: "David Morrison"
date: "07/08/2017"
---
# High Luminance Color Appearance Model 
This document aims to develop an improved color appearance model that can be used for the accurate analysis of images for artists and painters.
It is based on the 2009 research into extended luminance color appearance models beyond CIECAM02.

## References
* Kim, M., Weyrich, T. , Kautz, L, 2009. **Modeling human color perception under extended luminance levels**, ACM 
Trans. Graph. 28 (3), http://reality.cs.ucl.ac.uk/projects/xlrcam/kim09xlrcam.pdf


```{r Initialise, echo=FALSE}
require(ggplot2)
require(dplyr)
source("Projects/color-model-hlcam/hlcamFunctions.R")

```
## Load the experimental data
Extract the data from the pdf at http://jankautz.com/publications/experimental_data.pdf
1. Copy the PDF's text to data_raw.txt
2. Run the node program 'node data_extract.js'

```{r loaddata}
all=read.csv(file="Projects/color-model-hlcam/data_perceptual.csv",header=TRUE)
```

## Explore the data
Luminance Range and Background Level has strongest influence on color perception.

Lighting Conditions
1. CCT - Correlated color termperature of illuminant in 'Kelvin. Candle (1850K), Incandescent Lamp (2400K), Warm CFL (3000K), Moonlight (4100K), Horizon daylight (D50 5000K), Vertical daylight (D55 5500K - D60 6000K), Midday (5780K), Overcast/LCD (D65 6500K), Clear blue poleward sky (15000K - 27000K)
2. Xw, Yw, Zw - XYZ for Adopted White in test illuminant, Yw is also the Peak Luminance given its white
3. Pb - Background lightness percentage = Yb / Yw * 100. Ranges from 0 to 100.
4. Xb, Yb, Zb - XYZ for Background

Physical measures
1. Xs, Ys, Zs - XYZ for sample under test illuminant

Perceptual measures
1. Hs - Hue quadrature. Varies from 0 to 400: redness (0) - yellowness (100) - greenness (200) - blueness (300) - redness (400)
2. Js - Lightness. A scale of 0â€“100 relative to the brightness of reference white
3. Ms - Colorfulness. An absolute scale of 0 to unlimited, but typically 0 to 100


```{r explore}


## confirm relationship between CCT and Xw, Yw, Zw
## CCT1 calc using McCamy's Approximation https://en.wikipedia.org/wiki/Color_temperature#Approximation
## inverse using Plankian locus Approximation https://en.wikipedia.org/wiki/Planckian_locus#Approximation
all$CCT1 = XYZtoCCT(all$Xw, all$Yw, all$Zw)
ggplot(data=all)+aes(x=CCT, y=CCT1)+geom_point()

## confirm relationship between Xw, Yw, Zw and Xb, Yb, Zb is just the Pb ratio 
all$Yb1 = all$Yw * all$Pb / 100
ggplot(data=all)+aes(x=Yb, y=Yb1, color=Ms)+geom_point()
all$Xb1 = all$Xw * all$Pb / 100
ggplot(data=all)+aes(x=Xb, y=Xb1, color=Ms)+geom_point()
all$Zb1 = all$Zw * all$Pb / 100
ggplot(data=all)+aes(x=Zb, y=Zb1, color=Ms)+geom_point()

## confirm any relationship between La and Yb, should be similar since the background takes up the most of the adaption field
ggplot(data=all)+aes(x=Yb, y=La, color=Pb)+geom_point()

## explore measures Xs, Ys, Zs
ggplot(data=all)+geom_jitter(aes(y=Xs,x="Xs"))+geom_jitter(aes(y=Ys,x="Ys"))+geom_jitter(aes(y=Zs,x="Zs"))+geom_jitter(aes(y=La,x="La"))+ theme(axis.title.x = element_blank())+ theme(axis.title.y = element_blank())

## explore perceptual measures Js, Ms, Hs
ggplot(data=all)+geom_jitter(aes(y=Js,x="Js"))+geom_jitter(aes(y=Ms,x="Ms"))+geom_jitter(aes(y=Hs,x="Hs"))+ theme(axis.title.x = element_blank())+ theme(axis.title.y = element_blank())
ggplot(data=all)+aes(x=Hs, y=Js, color=Ms)+geom_point()

all <- subset(all, select = -c(CCT1, Xb1, Yb1, Zb1))

```

## Forward Color Appearance Model
Use the High Luminance Color Appearance Model to convert from XYZs to JHC, given XYZw, Ambient and La
Refer to http://reality.cs.ucl.ac.uk/projects/xlrcam/kim09xlrcam.pdf

```{r Forward}

## convert (color sample) and (adopted white) to LMS space
LMSs <- XYZtoLMS(all$Xs,all$Ys,all$Zs)
LMSw <- XYZtoLMS(all$Xw,all$Yw,all$Zw)

## use CAT02 to adapt the sample from the adopted white illumant to a reference white used in CIECAM02
D <- calculateD(all$Ambient, all$La)
LMSsc <- LMStoLMSc(D, LMSs, LMSw)
LMSwc <- LMStoLMSc(D, LMSw, LMSw)

## perform post adaption conversion to cone responses using Hunt-Pointer-Esteves
LMSsp <- LMSctoLMSp(LMSsc)
LMSwp <- LMSctoLMSp(LMSwc)

## convert to absolute cone responses
LMSsr <- LMSptoLMSr(LMSsp, all$La)
LMSwr <- LMSptoLMSr(LMSwp, all$La)

## Calculate achromatic and chromatic signals 
As <- LMSrtoA(LMSsr)
Aw <- LMSrtoA(LMSwr)
ab <- LMSrtoAB(LMSsr)

## calculate the perceived lightness (0 to 100) compared to reference white
all$Js1 <- AtoLightness(As, Aw, 1.0)
ggplot(data=all)+aes(x=Js, y=Js1, color=Hs)+geom_point()

## Calculate the Hue Quadrature based on chromatic signals
all$Hs1 <- ABtoHueQ(ab)
ggplot(data=all)+aes(x=Hs, y=Hs1, color=Hs)+geom_point()

## Calculate the Chroma based on chromatic signals
all$Cs1 <- ABtoChroma(ab)
ggplot(data=all)+aes(x=Ms, y=Cs1, color=Hs)+geom_point()

```

## Reverse Color Appearance Model
Use the High Luminance Color Appearance Model to convert from JHC to XYZ, given XYZw, Ambient and La
Refer to http://reality.cs.ucl.ac.uk/projects/xlrcam/kim09xlrcam.pdf

```{r Reverse}

## calculate the achromatic white point for the target device
RLMSw <- XYZtoLMS(all$Xw,all$Yw,all$Zw)
RD <- calculateD(all$Ambient, all$La)
RLMSwc <- LMStoLMSc(RD, RLMSw, RLMSw)
RLMSwp <- LMSctoLMSp(RLMSwc)
RLMSwr <- LMSptoLMSr(RLMSwp, all$La)
RAw <- LMSrtoA(RLMSwr)

# calculate the acrhomatic signal A from the sample lightness J
RAs <- LightnesstoA(all$Js1, RAw, 1.0)

# calculate the ab signal from the Hue Quadrant and Chroma 
Rab <- HueQChromatoAB(all$Hs1, all$Cs1)

# compute cone response LMS from the achromatic signal A and opponents a & b
RLMSsr <- AabtoLMSr(RAs, Rab)

# compute cone signal LMS from the LMS cone response and La
LMSsp <- LMSrtoLMSp(LMSsr, La)

# compute the color adapted LMS
LMSsc <- LMSptoLMSc(LMSsp)

# compute the raw LMS
LMS <- LMSctoLMS(LMSsc, D, LMSw)

# compute the XYZ
XYZ <- LMStoXYZ(LMS)   

```
## END
